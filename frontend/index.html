<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cobrança Premium</title>
    <!-- Modern Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-layer-group"></i> PremiumSys
            </div>
            <ul class="nav-links">
                <li><a href="#dashboard-section" class="active"><i class="fa-solid fa-chart-line"></i>
                        Dashboard</a></li>
                <li><a href="#billing-section"><i class="fa-solid fa-file-invoice-dollar"></i> Cobrança</a></li>
                <li><a href="#clients-section"><i class="fa-solid fa-users"></i> Clientes</a></li>
                <li><a href="#management-section"><i class="fa-solid fa-list-check"></i> Gestão</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="content">

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="tab-content active">
                <header class="section-header">
                    <div>
                        <h1>Dashboard</h1>
                        <p>Visão geral financeira</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="btn-icon" onclick="changeDashboardMonth(-1)" style="width: 36px; height: 38px;">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <input type="month" id="dashboard-month" class="input-dark" onchange="fetchDashboardData()">
                        <button class="btn-icon" onclick="changeDashboardMonth(1)" style="width: 36px; height: 38px;">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </header>

                <div class="stats-grid grid-container">
                    <div class="card stat-card">
                        <div class="icon-box bg-blue">
                            <i class="fa-solid fa-wallet"></i>
                        </div>
                        <div>
                            <h4 id="dash-month-title">Mês atual</h4>
                            <h2 id="dash-total-received">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-box bg-yellow">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div>
                            <h4>Pendente</h4>
                            <h2 id="dash-total-pending">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-box bg-red">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div>
                            <h4>Atrasado</h4>
                            <h2 id="dash-total-late">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-box bg-purple" style="background: #8b5cf6;">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div>
                            <h4>Total Alunos</h4>
                            <h2 id="dash-total-students">0</h2>
                        </div>
                    </div>
                    <!-- New Cards for Split Revenue -->
                    <div class="card stat-card">
                        <div class="icon-box bg-green">
                            <i class="fa-solid fa-chalkboard-user"></i>
                        </div>
                        <div>
                            <h4>Total Professores</h4>
                            <h2 id="dash-total-prof">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-box" style="background: #8b5cf6;">
                            <i class="fa-solid fa-church"></i>
                        </div>
                        <div>
                            <h4>Total Igreja</h4>
                            <h2 id="dash-total-church">R$ 0,00</h2>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-box" style="background: #f59e0b;">
                            <i class="fa-solid fa-user-slash"></i>
                        </div>
                        <div>
                            <h4>Isentos/Zerados</h4>
                            <h2 id="dash-total-exempt">0</h2>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="icon-box" style="background: #06b6d4;">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div>
                            <h4>Previsão Total</h4>
                            <h2 id="dash-total-forecast">R$ 0,00</h2>
                        </div>
                    </div>
                </div>

                <!-- Professor Revenue Breakdown -->
                <div class="card" style="margin-top: 2rem;">
                    <h3><i class="fa-solid fa-chart-pie"></i> Receita por Professor (Mês Atual)</h3>
                    <ul id="professor-revenue-list" class="stats-list">
                        <!-- Injected via JS -->
                    </ul>
                </div>

                <div class="grid-container" style="margin-top: 2rem;">
                    <div class="card">
                        <h3>Próximos Vencimentos</h3>
                        <ul id="upcoming-list" class="stats-list">
                            <!-- Injected via JS -->
                        </ul>
                    </div>
                    <div class="card">
                        <h3>Atrasos Recentes</h3>
                        <ul id="late-list" class="stats-list">
                            <!-- Injected via JS -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Management Section -->
            <section id="management-section" class="tab-content">
                <header class="section-header">
                    <div>
                        <h1>Gestão Escolar</h1>
                        <p>Professores e Cursos</p>
                    </div>
                </header>

                <!-- Management Tabs -->
                <div
                    style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <button id="tab-man-professors" class="tab-btn active" onclick="switchManagementTab('professors')">
                        <i class="fa-solid fa-chalkboard-user"></i> Professores
                    </button>
                    <button id="tab-man-courses" class="tab-btn" onclick="switchManagementTab('courses')">
                        <i class="fa-solid fa-graduation-cap"></i> Cursos
                    </button>
                </div>

                <!-- Professors Content -->
                <div id="man-professors-content">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Professores</h3>
                            <button class="btn-primary" onclick="openProfessorModal()"
                                style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                <i class="fa-solid fa-plus"></i> Novo
                            </button>
                        </div>
                        <ul id="professors-list" class="simple-list"></ul>
                    </div>
                </div>

                <!-- Courses Content -->
                <div id="man-courses-content" style="display: none;">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Cursos</h3>
                            <button class="btn-primary" onclick="openCourseModal()"
                                style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                                <i class="fa-solid fa-plus"></i> Novo
                            </button>
                        </div>
                        <ul id="courses-list" class="simple-list"></ul>
                    </div>
                </div>

            </section>

            <!-- Clients Section -->
            <section id="clients-section" class="tab-content">
                <header class="section-header">
                    <div>
                        <h1>Gestão de Clientes</h1>
                        <p>Cadastro e controle de alunos</p>
                    </div>

                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="position: relative;">
                            <i class="fa-solid fa-search"
                                style="position: absolute; left: 10px; top: 12px; color: var(--text-muted);"></i>
                            <input type="text" id="client-search" placeholder="Buscar cliente..."
                                style="padding-left: 35px; padding: 0.6rem 0.6rem 0.6rem 35px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: white; min-width: 250px;"
                                onkeyup="filterClients(this.value)">
                        </div>
                        <button id="btn-new-client" class="btn-primary">
                            <i class="fa-solid fa-plus"></i> Novo Cliente
                        </button>
                    </div>
                </header>

                <!-- Client Status Tabs -->
                <div
                    style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
                    <button id="tab-active-clients" class="tab-btn active" onclick="switchClientTab('active')">
                        <i class="fa-solid fa-users"></i> Ativos
                    </button>
                    <button id="tab-inactive-clients" class="tab-btn" onclick="switchClientTab('inactive')">
                        <i class="fa-solid fa-user-slash"></i> Inativos
                    </button>
                </div>

                <!-- Active Clients List -->
                <div id="active-clients-container">
                    <div class="grid-container" id="clients-list">
                        <!-- Cards will be injected here via JS -->
                    </div>
                </div>

                <!-- Inactive Clients List -->
                <div id="inactive-clients-container" style="display: none;">
                    <div class="grid-container" id="inactive-clients-list">
                        <!-- Inactive cards will be injected here via JS -->
                    </div>
                </div>
            </section>

            <!-- Billing Section -->
            <section id="billing-section" class="tab-content">
                <header class="section-header">
                    <div>
                        <h1>Central de Cobrança</h1>
                        <p>Gerencie os pagamentos mensais</p>
                    </div>

                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <!-- Filter Group -->
                        <div class="filter-group">
                            <!-- Helper Filter -->
                            <select id="billing-professor-filter" class="input-dark" onchange="filterBilling()"
                                style="min-width: 160px;">
                                <option value="all">Todos Professores</option>
                            </select>

                            <select id="billing-status-filter" class="input-dark" onchange="filterBilling()"
                                style="min-width: 140px;">
                                <option value="all">Todos Status</option>
                                <option value="PENDENTE">Pendentes</option>
                                <option value="PAGO">Pagos</option>
                                <option value="ATRASADO">Atrasados</option>
                            </select>

                            <input type="text" id="billing-search" class="input-dark" placeholder="Buscar aluno..."
                                onkeyup="filterBilling()" style="min-width: 200px;">
                        </div>

                        <!-- Date Picker -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="btn-icon" onclick="changeBillingMonth(-1)"
                                style="width: 36px; height: 38px;">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <input type="month" id="billing-month" class="input-dark" value="2024-01">
                            <button class="btn-icon" onclick="changeBillingMonth(1)" style="width: 36px; height: 38px;">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>

                        <button class="btn-primary" onclick="fetchBilling()">
                            <i class="fa-solid fa-sync"></i> Atualizar
                        </button>
                    </div>
                </header>

                <div class="card table-container">
                    <table class="billing-table">
                        <thead>
                            <tr>
                                <th>Aluno</th>
                                <th>Status</th>
                                <th>Valor Total</th>
                                <th>Divisão (Prof / Igreja)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="billing-list">
                            <!-- Rows via JS -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->

    <!-- Client Modal (Main) -->
    <div id="client-modal" class="modal-overlay hidden">
        <div class="card modal-card">
            <header class="modal-header">
                <h3>Cadastrar Novo Cliente</h3>
                <button class="btn-secondary" id="btn-close-client-modal"><i class="fa-solid fa-times"></i></button>
            </header>

            <form id="form-client" onsubmit="handleClientSubmit(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">

                    <!-- Personal Info -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Nome do Aluno</label>
                        <input type="text" id="client-name" required placeholder="Nome completo">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label>Endereço</label>
                        <input type="text" id="client-address" placeholder="Ex: Rua das Flores, 123">
                    </div>

                    <div class="form-group">
                        <label>WhatsApp</label>
                        <input type="text" id="client-phone" required placeholder="Ex: 5511999999999">
                    </div>

                    <!-- Enrollments List Section -->
                    <div
                        style="grid-column: span 2; margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <label style="color: #8b5cf6; font-weight: 600; font-size: 1.1rem;">
                                <i class="fa-solid fa-graduation-cap"></i> Matrículas (Cursos)
                            </label>
                            <button type="button" id="btn-open-matricula-modal" class="btn-secondary"
                                title="Vincular Curso">
                                <i class="fa-solid fa-plus"></i> Vincular Curso
                            </button>
                        </div>

                        <div id="enrollments-list" style="display: grid; gap: 0.5rem;">
                            <!-- Matrículas rendered via JS -->
                            <div
                                style="text-align: center; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 8px; color: #94a3b8;">
                                Nenhum curso vinculado ainda.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions"
                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn-icon btn-danger" id="btn-delete-client" title="Excluir"
                            style="display: none;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <button type="button" class="btn-secondary" id="btn-pause-client" style="display: none;">
                            <i class="fa-solid fa-pause"></i> Pausar
                        </button>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn-secondary" id="btn-cancel-client-modal">Cancelar</button>
                        <button type="submit" class="btn-primary" style="min-width: 120px;">Salvar Cliente</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Matricula (Enrollment) Modal - The "Box" -->
    <div id="matricula-modal" class="modal-overlay hidden" style="z-index: 2100;">
        <!-- Higher z-index to overlay client modal -->
        <div class="card modal-card" style="max-width: 600px;">
            <header class="modal-header">
                <h3>Vincular Curso</h3>
                <button class="btn-secondary" id="btn-close-matricula-modal"><i class="fa-solid fa-times"></i></button>
            </header>

            <form id="form-matricula" onsubmit="handleMatriculaSubmit(event)">
                <input type="hidden" id="matricula-id"> <!-- Hidden ID for Editing -->

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Course & Professor -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Curso</label>
                        <div class="input-with-button">
                            <select id="matricula-course" required>
                                <option value="">Selecione...</option>
                            </select>
                            <button type="button" class="btn-secondary" id="btn-qadd-course-mat">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label>Professor Responsável</label>
                        <div class="input-with-button">
                            <select id="matricula-professor" required>
                                <option value="">Selecione...</option>
                            </select>
                            <button type="button" class="btn-secondary" id="btn-qadd-prof-mat">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Dia Vencimento</label>
                        <input type="number" id="matricula-due-day" min="1" max="31" value="10" required>
                    </div>

                    <div class="form-group">
                        <label>Valor Mensalidade (R$)</label>
                        <input type="number" id="matricula-value" step="0.01" required placeholder="0.00" min="0"
                            oninput="calculateMatriculaSplit()">
                    </div>

                    <!-- Revenue Split Box -->
                    <div
                        style="grid-column: span 2; background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                        <label
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #8b5cf6; font-weight: 600;">
                            <i class="fa-solid fa-hand-holding-dollar"></i>
                            Divisão de Receita
                        </label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Professor Recebe (R$)</label>
                                <input type="number" id="matricula-valor-professor" step="0.01" placeholder="0.00"
                                    value="0" required oninput="calculateMatriculaSplit()">
                            </div>
                            <div class="form-group">
                                <label>Igreja Recebe (R$)</label>
                                <input type="number" id="matricula-valor-igreja" step="0.01" placeholder="0.00"
                                    value="0" required readonly style="background: rgba(0,0,0,0.2);">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions"
                    style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" id="btn-cancel-matricula-modal">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar Vínculo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div id="whatsapp-modal" class="modal-overlay hidden">
        <div class="card modal-card">
            <header class="modal-header">
                <h3>Enviar Mensagem</h3>
                <button class="btn-secondary" id="btn-close-modal"><i class="fa-solid fa-times"></i></button>
            </header>

            <div class="form-group">
                <label>Tipo de Mensagem</label>
                <div class="template-actions" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button type="button" class="btn-secondary" onclick="setMsgType('lembrete')"
                        style="flex: 1; font-size: 0.8rem;">
                        <i class="fa-regular fa-calendar"></i> Lembrete
                    </button>
                    <button type="button" class="btn-secondary" onclick="setMsgType('hoje')"
                        style="flex: 1; font-size: 0.8rem;">
                        <i class="fa-solid fa-bell"></i> Hoje
                    </button>
                    <button type="button" class="btn-secondary" onclick="setMsgType('atraso')"
                        style="flex: 1; font-size: 0.8rem;">
                        <i class="fa-solid fa-triangle-exclamation"></i> Atraso
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Prévia da Mensagem (Editável)</label>
                <textarea id="whatsapp-preview" rows="12"
                    style="width: 100%; padding: 0.8rem; background: var(--bg-dark); border: 1px solid var(--border); color: white; border-radius: 8px; font-family: monospace; font-size: 0.9rem;"></textarea>
            </div>

            <div class="form-actions">
                <div style="flex: 1;">
                    <select id="whatsapp-template" class="input-dark" style="width: 100%;">
                        <!-- Templates cargados via JS -->
                    </select>
                </div>
                <button type="button" class="btn-whatsapp" id="btn-send-whatsapp">
                    <i class="fa-brands fa-whatsapp"></i> Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Professor Modal -->
    <div id="professor-modal" class="modal-overlay hidden">
        <div class="card modal-card">
            <header class="modal-header">
                <h3 id="prof-modal-title">Novo Professor</h3>
                <button class="btn-secondary" id="btn-close-prof-modal"><i class="fa-solid fa-times"></i></button>
            </header>
            <form id="form-professor">
                <input type="hidden" id="prof-id">

                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="prof-nome" class="input-dark" required>
                </div>

                <div class="form-cols">
                    <div class="form-group">
                        <label>CPF/CNPJ</label>
                        <input type="text" id="prof-cpf" class="input-dark">
                    </div>
                    <div class="form-group">
                        <label>Contato (Tel/Email)</label>
                        <input type="text" id="prof-contato" class="input-dark">
                    </div>
                </div>

                <div class="form-group">
                    <label>Chave PIX</label>
                    <input type="text" id="prof-pix" class="input-dark">
                </div>

                <div class="form-group">
                    <label>Dados Bancários</label>
                    <textarea id="prof-dados-bancarios" rows="2" class="input-dark"
                        placeholder="Banco, Agência, Conta..."></textarea>
                </div>

                <div class="form-group">
                    <label>Endereço Completo</label>
                    <textarea id="prof-endereco" rows="2" class="input-dark"></textarea>
                </div>

                <div class="form-actions" style="margin-top: 1rem; display: flex; justify-content: flex-end;">
                    <button type="submit" class="btn-primary">Salvar Professor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="course-modal" class="modal-overlay hidden">
        <div class="card modal-card" style="max-width: 400px;">
            <header class="modal-header">
                <h3 id="course-modal-title">Novo Curso</h3>
                <button class="btn-secondary" id="btn-close-course-modal"><i class="fa-solid fa-times"></i></button>
            </header>
            <form id="form-course">
                <input type="hidden" id="course-id">

                <div class="form-group">
                    <label>Nome do Curso</label>
                    <input type="text" id="course-nome" class="input-dark" required placeholder="Ex: Piano, Inglês...">
                </div>

                <div class="form-group">
                    <label>Valor Mensalidade Padrão (R$)</label>
                    <input type="number" id="course-value" class="input-dark" required min="0" step="0.01"
                        placeholder="0.00">
                </div>

                <div class="form-actions" style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
                    <button type="submit" class="btn-primary">Salvar Curso</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden">Ação realizada com sucesso!</div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay hidden" style="display: none;">
        <div class="card modal-card" style="max-width: 400px; text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 id="confirm-title" style="margin-bottom: 0.5rem;">Tem certeza?</h3>
            <p id="confirm-message" style="color: #94a3b8; margin-bottom: 1.5rem;">Essa ação não pode ser desfeita.</p>

            <div class="modal-confirm-actions">
                <button class="btn-ghost" onclick="window.closeConfirmModal()">Cancelar</button>
                <button class="btn-primary" id="btn-confirm-action">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Scripts -->
    <script type="module" src="js/modules/main.js"></script>
</body>

</html>